pipeline {
  agent any
  environment {
    DOCKER_IMAGE = 'amine101yahya/mon-app'
    IMAGE_TAG = "${env.BUILD_NUMBER ?: 'latest'}"
  }
  stages {
    stage('Build Docker image') {
      steps {
        script {
          sh "docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} ."
        }
      }
    }
    stage('Push image to Docker Hub') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
          sh 'echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin'
          sh "docker push ${DOCKER_IMAGE}:${IMAGE_TAG}"
        }
      }
    }
    stage('Deploy to Kubernetes (kubectl)') {
      steps {
        script {
          // This pipeline uses a kubeconfig provided as a Jenkins "Secret file" credential
          // Create a credential in Jenkins (Kind: "Secret file") with ID `kubeconfig` containing your kubeconfig
          // The file will be exposed as a temp file path in the variable $KUBECONFIG_FILE below.
          withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_FILE')]) {
            // Use the credential file with --kubeconfig to run kubectl authenticated
            sh "kubectl --kubeconfig=$KUBECONFIG_FILE set image deployment/mon-app-deployment mon-app=${DOCKER_IMAGE}:${IMAGE_TAG} --record || kubectl --kubeconfig=$KUBECONFIG_FILE apply -f k8s/deployment.yaml"
            sh "kubectl --kubeconfig=$KUBECONFIG_FILE apply -f k8s/service.yaml || true"
          }
        }
      }
    }
  }
  post {
    always {
      echo "Pipeline finished"
    }
  }
}
