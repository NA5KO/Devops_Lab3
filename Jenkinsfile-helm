pipeline {
  agent any
  environment {
    DOCKER_IMAGE = 'amine101yahya/mon-app'
    IMAGE_TAG = "${env.BUILD_NUMBER ?: 'latest'}"
    HELM_CHART_PATH = './mon-app'
  }
  stages {
    stage('Clone repository') {
      steps {
        git url: 'https://github.com/NA5KO/Devops_Lab3#'
      }
    }
    stage('Build Docker image') {
      steps {
        script {
          sh "docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} ."
        }
      }
    }
    stage('Push image to Docker Hub') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
          sh 'echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin'
          sh "docker push ${DOCKER_IMAGE}:${IMAGE_TAG}"
        }
      }
    }
    stage('Deploy with Helm') {
      steps {
        script {
          // Pass image values to Helm chart
          sh "helm upgrade --install mon-app ${HELM_CHART_PATH} --set image.repository=${DOCKER_IMAGE} --set image.tag=${IMAGE_TAG}"
        }
      }
    }
  }
  post {
    always {
      echo "Helm pipeline finished"
    }
  }
}
